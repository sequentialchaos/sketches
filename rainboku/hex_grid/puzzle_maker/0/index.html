<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Rainboku Puzzle</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://unpkg.com/d3-simple-slider"></script>
  <script src="/sketches/lib/FileSaver.js"></script>
  <script src="/sketches/lib/hex.js?1"></script>
  <style type="text/css">
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <script type="text/javascript">

    let w = window.innerWidth,
        h = window.innerHeight;

    let saveButton = d3.select("body")
      .append("button")
        .text("Save")
        .style("top", Math.round(h * 0.01) + "px")
        .style("left", Math.round(w * 0.01) + "px")
        .style("position", "absolute")
        .style("width", "100px")
        .style("height", "40px")
        .style("font-size", "30px")
        .style("font-weight", "bold")
        .style("-webkit-user-select", "none")
        .style("-moz-user-select", "none")
        .style("-ms-user-select", "none")
    
    let loadButton = d3.select("body")
      .append("button")
        .text("Load")
        .style("top", Math.round(h * 0.01) + "px")
        .style("left", Math.round(w * 0.02 + 100) + "px")
        .style("position", "absolute")
        .style("width", "100px")
        .style("height", "40px")
        .style("font-size", "30px")
        .style("font-weight", "bold")
        .style("-webkit-user-select", "none")
        .style("-moz-user-select", "none")
        .style("-ms-user-select", "none")

    let loadInput = d3.select("body")
      .append("input")
        .attr("type", "file")
        .attr("id", "file-input")
        .attr("name", "puzzle")
        .attr("accept", ".txt")
        .style("display", "none")

    let clearButton = d3.select("body")
      .append("button")
        .text("Clear")
        .style("top", Math.round(h * 0.01) + "px")
        .style("left", Math.round(w * 0.02 + 100 + 115) + "px")
        .style("position", "absolute")
        .style("width", "100px")
        .style("height", "40px")
        .style("font-size", "30px")
        .style("font-weight", "bold")
        .style("-webkit-user-select", "none")
        .style("-moz-user-select", "none")
        .style("-ms-user-select", "none")
    
    // let sizeSlider = d3.sliderBottom()
    //   .min(10)
    //   .max(120)
    //   .step(1)
    //   .width(200)
    //   .ticks(10)
    //   .fill("cyan")
    
    let sizeSlider = d3.select("body")
      .append("input")
        .attr("type", "range")
        .attr("min", 10)
        .attr("max", 120)
        .attr("step", 1)
        .attr("value", 40)
        .style("top", Math.round(h * 0.01) + "px")
        .style("left", Math.round(w * 0.02 + 100 + 115 + 115) + "px")
        .style("position", "absolute")
        .style("color", "red")

    // let originInput = d3.select("body")
    //   .append("input")
    //     .attr("id", "origin-input")
    //     .attr("type", "text")
    //     .style("top", Math.round(h * 0.01) + "px")
    //     .style("left", Math.round(w * 0.02 + 100 + 120 + 200) + "px")
    //     .style("width", "100px")
    //     .style("position", "absolute")
    //     .style("font-size", "30px")

    // let originButton = d3.select("body")
    //   .append()

    let svg = d3.select("body")
      .append("svg")
        .attr("width", w)
        .attr("height", h)
        .attr("viewBox", [(-w/2), (-h/2), w, h].join(" ")) // center at (0, 0)
        // .attr("transform", "scale(1, -1)"); // flip y

    // background
    svg.append("rect")
        .attr("x", (-w/2))
        .attr("y", (-h/2))
        .attr("width", w)
        .attr("height", h)
        .attr("fill", "white");

    let hexOptions = {
      fill: "white",
      "fill-opacity": 0.8,
      stroke: "black", 
      "stroke-width": "4px"
    }
    let r = +sizeSlider.attr("value")
    let hex = new Hex(0, 0)
    let size = new Point(r, -r)
    let origin = new Point(0, 0)
    let grid = new Grid(POINTY, size, origin)

    let fractionHex = new Hex(1.8, -2.4)

    let puzzle = new Puzzle(grid, 4, from="0,0,1")
    // puzzle.regularHex(4) 
    
    // puzzle.surroundAll(5)
    // puzzle.addNew(0, 0)
    puzzle.drawOnSVG()

    d3.selectAll(".hexagon") 
      .on("click", () => {
        let hex = d3.select(this)
        console.log(hex)
        let id = hex.attr("id")
        hex.attr("fill", "cyan")
        puzzle.drawOnSVG()
      })

    svg.on("click", () => {
      let click = d3.mouse(d3.event.currentTarget)
      let p = new Point(click[0], click[1])
      let h = new Hex().fromPixel(grid, p)
      if (puzzle.contains(h)) {
        puzzle.remove(h)
      } else {
        puzzle.add(h)
      }
      puzzle.drawOnSVG()
      // console.log(h)
      // console.log(puzzle.toString())
      // console.log(puzzle)
    })

    saveButton.on("click", () => {
      puzzle.save()
    })

    let fileInput = document.getElementById("file-input")
    loadButton.on("click", () => {
      fileInput.click()
    })

    loadInput.on("change", () => {
      file = fileInput.files[0]
      if (file) {
        let reader = new FileReader();
        reader.readAsText(file, "UTF-8");
        reader.onload = function (evt) {
          puzzle.clear()
          puzzle.load(reader.result)
          puzzle.drawOnSVG()
        }
        reader.onerror = function (evt) {
          console.log("error reading file");
        }
      }
    })

    clearButton.on("click", () => {
      puzzle.clear()
      puzzle.addNew(0, 0)
      puzzle.drawOnSVG()
    })

    sizeSlider.on("change", () => {
      r = sizeSlider.property("value")
      console.log(r)
      size = new Point(r, -r)
      grid = new Grid(POINTY, size, origin)
      
      let puzzleString = puzzle.toString()
      console.log(puzzleString)
      puzzle = new Puzzle(grid, from=puzzleString)
      puzzle.drawOnSVG()
    })
    </script>
</body>
</html>