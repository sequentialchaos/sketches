<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Rainboku Puzzle</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  <script src="/sketches/lib/FileSaver.js"></script>
  <script src="/sketches/lib/hex.js"></script>
  <style type="text/css">
    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    #settings {
      /* display: grid; */
      padding: 4px;
      /* grid-template-rows: repeat(5, 1fr); */
      position: absolute;
      width: 300;
      height: 300;
      z-index: 1;
      background-color: rgb(204, 205, 214);
      border: 5px solid rgb(133, 129, 129);
    }

    #save-load-clear {
      display: flex;
      width: 100%;
      /* border: 5px solid green; */
    }

    #grid {
      position: absolute;
      /* border: 5px solid black; */
    }

    .btn {
      width: 100px;
      height: 44px;

      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    .size {
      display: flex;
      width: 100%;
    }

    .slider {
      width: 86.58%;
    }

    .label {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
  </style>
</head>

<body>
  <div id="settings">
    <div id="save-load-clear"></div>
    <div id="size"></div>
    <div id="types">
      <svg height="30"></svg>
    </div>
  </div>
  <div id="grid">
    <script type="text/javascript">

      let saveButton = d3.select("#save-load-clear")
        .append("button")
        .attr("class", "btn")
        .text("Save")

      let loadButton = d3.select("#save-load-clear")
        .append("button")
        .attr("class", "btn")
        .text("Load")

      let clearButton = d3.select("#save-load-clear")
        .append("button")
        .attr("class", "btn")
        .text("Clear")

      let loadInput = d3.select("#settings")
        .append("input")
        .attr("type", "file")
        .attr("id", "file-input")
        .attr("name", "puzzle")
        .attr("accept", ".txt")
        .style("display", "none")

      d3.select("#size")
        .append("p")
        .style("width", "100%")
        .text("Size: ")


      let sizeSlider = d3.select("#size > p")
        .append("input")
        .attr("class", "slider")
        .attr("type", "range")
        .attr("min", 10)
        .attr("max", 120)
        .attr("step", 1)
        .attr("value", 40)
        .style("color", "red")



      let gridDimensions = d3.select("#grid").node().getBoundingClientRect(),
        w = window.innerWidth,
        h = window.innerHeight

      let svg = d3.select("#grid")
        .append("svg")
        .attr("class", "grid-main")
        .attr("width", w)
        .attr("height", h)
        .attr("viewBox", [(-w / 2), (-h / 2), w, h].join(" ")) // center at (0, 0)

      let hex = new Hex(0, 0)

      let colors = hex.colors
      let selectedType = 0
      const createPalette = (svg, colors) => {
        let svgWidth = +svg.style("width").split("p")[0];
        let svgHeight = +svg.style("height").split("p")[0];
        console.log(svgWidth)
        colors.forEach((color, i) => {
          let width = 100 / colors.length
          let x = width * i
          let g = svg.append("g")
          let rect = g.append("rect")
              .attr("class", i-1)
              .attr("fill", color)
              .attr("width", width + "%")
              .attr("height", "100%")
              .attr("x", x + "%")
              .style("cursor", "pointer")
              .on("click", () => {
                selectedType = i-1
                console.log(selectedType)
              })
            
          x = svgWidth / colors.length * i + svgWidth / colors.length / 2
          let y = svgHeight / 2 + 2
          console.log(x)
          let text = g.append("text")
              .attr("class", i-1)
              .attr("x", x + "px")
              .attr("y", y + "px")
              .text(i > 1 ? i-1 : "")
              .style("cursor", "pointer")
              .style("font-size", "28px")
              .style("fill", "black")
              .style("text-anchor", "middle")
              .style("alignment-baseline", "middle")
              // .style("z-index", -1)
              .on("click", () => {
                selectedType = i-1
                console.log(selectedType)
              })
        })
      }
      let colorPalette = d3.select("#types > svg")
      createPalette(colorPalette, colors)

      let r = +sizeSlider.attr("value")
      let size = new Point(r, -r)
      let origin = new Point(0, 0)
      let grid = new Grid(POINTY, size, origin)
      let puzzle = new Puzzle(grid, 4, from = "0,0,1")
      // puzzle.regularHex(4) 
      // puzzle.surroundAll(5)
      // puzzle.addNew(0, 0)

      puzzle.drawOnSVG()
      d3.selectAll(".hexagon")
        .on("click", () => {
          let hex = d3.select(this)
          console.log(hex)
          let id = hex.attr("id")
          hex.attr("fill", "cyan")
          puzzle.drawOnSVG()
        })

      svg.on("click", () => {
        let click = d3.mouse(d3.event.currentTarget)
        let p = new Point(click[0], click[1])
        let h = new Hex().fromPixel(grid, p)
        h.setType(selectedType)
        if (puzzle.contains(h)) {
          puzzle.remove(h)
        } else {
          puzzle.add(h)
        }
        puzzle.drawOnSVG()
        // console.log(h)
        // console.log(puzzle.toString())
        // console.log(puzzle)
      })

      saveButton.on("click", () => {
        puzzle.save()
      })

      let fileInput = document.getElementById("file-input")
      loadButton.on("click", () => {
        fileInput.click()
      })

      loadInput.on("change", () => {
        file = fileInput.files[0]
        if (file) {
          let reader = new FileReader();
          reader.readAsText(file, "UTF-8");
          reader.onload = function (evt) {
            puzzle.clear()
            puzzle.load(reader.result)
            puzzle.drawOnSVG()
          }
          reader.onerror = function (evt) {
            console.log("error reading file");
          }
        }
      })

      clearButton.on("click", () => {
        puzzle.clear()
        puzzle.addNew(0, 0)
        puzzle.drawOnSVG()
      })

      sizeSlider.on("change", () => {
        r = +sizeSlider.property("value")
        console.log(r)
        size = new Point(r, -r)
        grid = new Grid(POINTY, size, origin)

        let puzzleString = puzzle.toString()
        console.log(puzzleString)
        puzzle = new Puzzle(grid, 4, from = puzzleString)
        puzzle.drawOnSVG()
      })
    </script>
  </div>

</body>

</html>